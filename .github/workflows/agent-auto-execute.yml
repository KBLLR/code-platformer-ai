name: Agent Auto-Execute Tasks

on:
  workflow_dispatch:
    inputs:
      project:
        description: "Project name"
        required: true
        default: "webgpu-battle-royale"
        type: choice
        options:
          - webgpu-battle-royale
          - gameplay-hardening
      task_id:
        description: "Task ID (leave empty for auto-pick)"
        required: false
        type: string
      agent_codename:
        description: "Codename for the human agent who will continue the task"
        required: false
        type: string
      notify_user:
        description: "GitHub username to ping in the PR (optional)"
        required: false
        type: string

  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"

jobs:
  prepare-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Determine project
        id: project
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "name=${{ github.event.inputs.project }}" >> "$GITHUB_OUTPUT"
          else
            # Default for scheduled runs
            echo "name=webgpu-battle-royale" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine task selection mode
        id: task_mode
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.task_id }}" ]; then
            echo "mode=specific" >> "$GITHUB_OUTPUT"
            echo "task_id=${{ github.event.inputs.task_id }}" >> "$GITHUB_OUTPUT"
          else
            echo "mode=auto-pick" >> "$GITHUB_OUTPUT"
          fi

      - name: Gather agent metadata
        id: agent_meta
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "codename=${{ github.event.inputs.agent_codename }}" >> "$GITHUB_OUTPUT"
            echo "notify=${{ github.event.inputs.notify_user }}" >> "$GITHUB_OUTPUT"
          else
            echo "codename=" >> "$GITHUB_OUTPUT"
            echo "notify=" >> "$GITHUB_OUTPUT"
          fi

      - name: Execute agent task selector
        id: execute
        run: |
          PROJECT="${{ steps.project.outputs.name }}"
          AGENT_CODENAME="${{ steps.agent_meta.outputs.codename }}"

          if [ "${{ steps.task_mode.outputs.mode }}" == "specific" ]; then
            TASK_ID="${{ steps.task_mode.outputs.task_id }}"
            echo "Executing specific task: $TASK_ID"
            python agentship-x-htdi/scripts/agent_executor.py --project "$PROJECT" --task "$TASK_ID" ${AGENT_CODENAME:+--agent "$AGENT_CODENAME"}
          else
            echo "Auto-picking highest priority task"
            python agentship-x-htdi/scripts/agent_executor.py --project "$PROJECT" --auto-pick ${AGENT_CODENAME:+--agent "$AGENT_CODENAME"}
          fi

          # Extract task ID from session log
          LATEST_SESSION=$(ls -t "agentship-x-htdi/projects/$PROJECT/sessions/"*.md | grep -v README | grep -v prompt | head -1)
          if [ -n "$LATEST_SESSION" ]; then
            TASK_ID=$(basename "$LATEST_SESSION" | grep -oP '[A-Z]+-\d+')
            echo "task_id=$TASK_ID" >> "$GITHUB_OUTPUT"

            # Extract task title
            TASK_TITLE=$(grep "^# Session Log -" "$LATEST_SESSION" | sed 's/# Session Log - //')
            echo "task_title=$TASK_TITLE" >> "$GITHUB_OUTPUT"
          fi

      - name: Create branch for task
        id: branch
        if: steps.execute.outputs.task_id != ''
        run: |
          TASK_ID="${{ steps.execute.outputs.task_id }}"
          BRANCH_NAME="agent/task-$(echo "$TASK_ID" | tr '[:upper:]' '[:lower:]')"

          git config user.name "Agent Automation"
          git config user.email "agent@codeplatformer.ai"

          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Commit task preparation
        if: steps.execute.outputs.task_id != ''
        run: |
          TASK_ID="${{ steps.execute.outputs.task_id }}"

          git add "agentship-x-htdi/projects/${{ steps.project.outputs.name }}/"
          git add agentship-x-htdi/profiles/ 2>/dev/null || true

          git commit \
            -m "[$TASK_ID] Prepare task execution" \
            -m "Task: ${{ steps.execute.outputs.task_title }}" \
            -m "Project: ${{ steps.project.outputs.name }}" \
            -m "Mode: ${{ steps.task_mode.outputs.mode }}" \
            -m "- Created session log" \
            -m "- Generated implementation prompt" \
            -m "- Updated task status to 'In Progress'" \
            -m "Auto-generated by agent-auto-execute workflow"

      - name: Push branch
        if: steps.execute.outputs.task_id != ''
        run: |
          git push origin "${{ steps.branch.outputs.branch_name }}"

      - name: Create Pull Request
        if: steps.execute.outputs.task_id != ''
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.branch_name }}
          title: "[${{ steps.execute.outputs.task_id }}] ${{ steps.execute.outputs.task_title }}"
          body: |
            ## Task Preparation

            **Project:** ${{ steps.project.outputs.name }}
            **Task ID:** ${{ steps.execute.outputs.task_id }}
            **Task:** ${{ steps.execute.outputs.task_title }}
            **Mode:** ${{ steps.task_mode.outputs.mode }}
            ${{ steps.agent_meta.outputs.codename && format('**Assigned Agent:** {0}', steps.agent_meta.outputs.codename) || '' }}

            ---

            ## What's Next

            This PR contains the task preparation (session log and implementation prompt).

            An agent should now:
            1. Review the implementation prompt
            2. Implement the task
            3. Update the session log with progress
            4. Complete their profile at `agentship-x-htdi/profiles/${{ steps.agent_meta.outputs.codename || 'your-codename' }}.md`
            5. Push changes to this branch
            6. Request review when complete

            ---

            ## Session Log

            See `agentship-x-htdi/projects/${{ steps.project.outputs.name }}/sessions/` for the session log.

            ---

            *Auto-generated by agent-auto-execute workflow*
          labels: |
            automation
            agent-task
            ${{ steps.project.outputs.name }}
          draft: true
          assignees: ${{ steps.agent_meta.outputs.notify }}

      - name: Notify assigned human
        if: steps.agent_meta.outputs.notify != '' && steps.pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const notify = process.env.NOTIFY_USER;
            const agent = process.env.AGENT || 'agent team';
            if (!notify) {
              core.info('No notify_user provided, skipping mention.');
              return;
            }
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body: `Hey @${notify}, automation prepped task **${process.env.TASK_ID}** for codename **${agent}**. Please finish the agent profile, follow the implementation prompt, and push commits to this branch when ready.`
            });
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pull-request-number }}
          NOTIFY_USER: ${{ steps.agent_meta.outputs.notify }}
          AGENT: ${{ steps.agent_meta.outputs.codename }}
          TASK_ID: ${{ steps.execute.outputs.task_id }}

      - name: Summary
        if: steps.execute.outputs.task_id != ''
        run: |
          echo "## Task Preparation Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Project:** ${{ steps.project.outputs.name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Task ID:** ${{ steps.execute.outputs.task_id }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Task:** ${{ steps.execute.outputs.task_title }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Branch:** ${{ steps.branch.outputs.branch_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Ready for agent implementation!" >> "$GITHUB_STEP_SUMMARY"
