# Agent Workflow Guidelines

## Mission Snapshot

- Read this guide once, then immediately open `agents/HANDOFFS.md` and follow the latest entry so work continues seamlessly.
- Start every engagement by scanning `agents/AUDIT-log.md` for current gaps and priorities. The active stream is **Gameplay Hardening Initiative** stored in `agents/projects/gameplay-hardening/`.
- Review `agents/OPENTASKS.md` to see global backlog and in-progress tickets before claiming work.
- All new efforts must map to a task ID in `tasks.md`; if the work does not exist yet, add a Backlog entry before writing code.

## Workspace Anatomy

- `agents/templates/` holds the canonical blueprints (audit log, project template, session template). Copy from here when spinning up a new initiative.
- `agents/projects/<project-name>/README.md` captures scope + success criteria, `tasks.md` manages state, `sessions/` holds timestamped logs, `qa/` contains per-run checklists, and `future-features/` is the parking lot.
- `agents/audits/` is fully auto-generated via `generate_audit.py`; edit the source project docs instead of these outputs.
- `agents/SITEMAP.md` and `agents/SITEMAP_DETAILED.md` describe repo structure and are regenerated by `generate_sitemap.py`.
- `agents/OPENTASKS.md` aggregates Backlog + In Progress rows from every `tasks.md` file using `collect_opentasks.py`.
- Source lives under `src/` (rendering, physics, UI, AI). Static shells + assets live in `public/`. Use Vite aliases (`@`, `@ui`, `@assets`, etc.) instead of deep relative paths.

## Working Session Flow

1. Claim or create a task (e.g., `GH-001`) in `tasks.md`, assign yourself, and move it to the appropriate section.
2. Create a session log before coding via the helper script (auto-fills timestamps):

   ```bash
   python agents/scripts/init_agent_session.py --project gameplay-hardening --task GH-001 --title "Audit follow-up"
   ```

3. Note objectives, entry points, commands run, and link the relevant task IDs inside the log.
4. Keep your session file updated as you work; commit it alongside the code and reference it in PR descriptions.

## ⚙️ Automation Loop

- Scripts live in `agents/scripts/`:
  - `generate_audit.py` — scans `agents/projects/*` and writes per-project audits to `agents/audits/`.
  - `generate_sitemap.py` — refreshes `agents/SITEMAP.md` plus `agents/SITEMAP_DETAILED.md`.
  - `collect_opentasks.py` — gathers Backlog/In Progress tables into `agents/OPENTASKS.md`.
  - `handoff_sync.py` — appends PR summaries (with the `handoff` label) to `agents/HANDOFFS.md`; use `--force` or `--append` for manual notes.
  - `init_agent_session.py` — clones the session template with pre-filled metadata.
- Local single-command entrypoint:

  ```bash
  npm run agents:update
  ```

  This runs the three generators in order so audits, sitemaps, and the open-task ledger stay fresh.

- CI behavior:
  - `.github/workflows/agents-ci.yml` runs generators on every push to `main`, every Monday at 09:00 UTC, and whenever you trigger the manual dispatch. It also reacts to merged PRs labeled `handoff` to run `handoff_sync.py`.
  - The manual dispatch route adds markdown linting, posts a summary comment (if a PR number is provided), and appends an `automation:ci-validation` entry to `agents/HANDOFFS.md`.
- Contribution flow:
  1. Pull latest `main`.
  2. Run `npm run agents:update`.
  3. Review diffs under `agents/audits/`, `agents/SITEMAP*.md`, `agents/OPENTASKS.md`, and `agents/HANDOFFS.md`.
  4. Commit alongside your feature work, referencing the relevant task ID and session log.
- Outputs land under `agents/audits/`, `agents/SITEMAP*.md`, `agents/OPENTASKS.md`, and `agents/HANDOFFS.md`. Do not edit these files by hand—re-run the generators instead.
- `.env.example` at repo root documents non-secret runtime vars (update it when env requirements change so audits stay honest).

## Setup: CI Secrets

- Use `scripts/ci/seed-secrets.zsh` to populate required GitHub secrets:
  - `ANTHROPIC_API_KEY`
  - `GEMINI_API_KEY`
  - `OPENAI_API_KEY`
- Example:

  ```bash
  export ANTHROPIC_API_KEY=...
  export GEMINI_API_KEY=...
  export OPENAI_API_KEY=...
  ./scripts/ci/seed-secrets.zsh
  ```

- Never commit actual secret values; keep `.env` local and rely on `.env.example` for documentation only.

## External Agent Runners

- `.github/workflows/agents-claude.yml` — Anthropic Claude picks a task from `agents/OPENTASKS.md`, runs the generators, and commits changes (manual dispatch).
- `.github/workflows/agents-gemini.yml` — Google Gemini CLI mirrors the same flow via manual dispatch.
- `.github/workflows/agents-codex.yml` — OpenAI Codex executes the generator trio, writes a summary, and commits results when dispatched.
- `.github/workflows/agents-jules-bridge.yml` — creates Jules-friendly GitHub issues for labeled OPENTASKS so the hosted agent can open PRs.
- All agent workflows:
  - restrict edits to `agents/**`
  - log activity via `agents/scripts/handoff_sync.py`
  - create PRs or commits labeled `automation` + `handoff`
  - require maintainers to review before merging

## Build, Test, and QA
- `npm install` — sync dependencies after every branch switch.
- `npm run dev` — Vite dev server with HMR; append `?state=game` or `?state=onboarding` for shortcuts.
- `npm run build` — production bundle in `dist/`; required before any PR review.
- `npm run preview` — validate built assets and relative URLs locally.
- For manual QA runs, duplicate `agents/projects/gameplay-hardening/qa/qa-checklist.md`, fill it out, and attach links/screenshots in the PR.

## Coding Standards & PR Etiquette
- Stick to ES modules, two-space indentation, descriptive `[Module] message` logging, and alias-based imports. Co-locate new helpers with their systems instead of creating root-level singletons.
- Introduce unit tests with `vitest` for deterministic logic; for systems without coverage, document manual steps in the QA checklist.
- Commit messages follow imperative tone (`Add session workflow hooks`). Reference task IDs in either the subject or body.
- Every PR must include: linked task IDs, session log filenames, QA checklist link/result, `.env` considerations, and screenshots/video for UI changes. Ensure `npm run build` has passed locally before requesting review.
- Add the `handoff` label to PRs that finish a work stream so automation can append the summary entry automatically.
